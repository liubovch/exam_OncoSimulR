---
title: "Frequency-dependet fitness"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Frequency dependent fitness simulations {#FDF}

## Game-theory cancer progression models {#models}

### Hallmarks of cancer {#Hallmarks}

The models below consider possible behaviours mutant cells can acquire in order to transform a tissue into a malignant cancer, the so-called "Hallmarks of cancer".

By using game theory, we will see how the interaction between different phenotypes with different capabilities or strategies can produce different evolutionary paths, some of them leading to tumor spread while others not.

We make the following assumptions:
  
  * Asexual reproduction. 

* Different tumour genotypes (strategies) evolve from WT cells, being its initial count 0.

* Genotypes are distributed homogeneously in the tumour and probability of cell interaction depends only on genotype frequency, not in its spatial arrangement.

#### Evasion of apoptosis {#apoptosis}

Under normal circumstances, malignant cells will kill themselves when receiving certain signals, this is the phenomenon known as "apoptosis", or programmed cell death, a security mechanism that prevents tumor growth. Therefore,  for a cancer to be able to spread, its cells have to develop capabilities that allow them to avoid apoptosis.

In this model from Tomlinson and Bodmer (1997), we consider 3 strategies, each of them corresponding to a different mutant genotype:
  
  1. Cells produce a growth factor to prevent apoptosis of neighboring cells. This factor has not effect on the cells producing it (paracrine).

2. Cells produce a growth factor to prevent apoptosis of themselves (autocrine).

3. Cells don’t produce any growth factor but benefit from the factor produced by cells of type A.  

The payoff matrix is the following:
  
          **A    	    B 		      C**
  
  **A**	  1 − a + b 	1 + b + c 	1 + b 

  **B **	1 − a 		  1 + c 		  1 

  **C** 	1 − a 		  1 + c		    1

Being:  
  
  * a the cost of producing the paracrine factor

  * b the benefit of receiving the paracrine factor

  * c the benefit of producing the autocrine factor

The fitness of the different genotypes can be modelled as a function of its frequencies based on this payoff matrix. Taking into account we have wild type cells in the tissue, from which the 3 types of mutants evolve, with a neutral fitness of 1, we can describe the fitness of all players involved in the game like this: 
  
FWT = 1

FA = 1 + f_A*(1 - a + b) + f_B*(1 - a) + f_C*(1 - a)

FB = 1 + f_A*(1 + b + c) + f_B*(1 + c) + f_C*(1 + c)

FC = 1 + f_A*(1 + b) + f_B + f_C

We model this game using OncoSimulR, with 3 genes and 8 possible genotypes, being just 4 of them viables (the other will have fitnes 0).

We start from a WT population of 5000 cells, and run the simulations 1000 time units, with a mutation rate of 1e-5  to see faster the dynamics of the tumor cells evolution.

```{r}

library("OncoSimulR")
library("ggplot2")
library("doParallel")

set.seed(1)

a <- 1

b <- 3

c <- 2

fa <- paste("1+f_A*(",as.character(1-a+b),
            
            ")+f_B*(",as.character(1-a),
            
            ")+f_C*(",as.character(1-a),")",
            
            sep="")

fb <- paste("1+f_A*(",as.character(1+b+c),
            
            ")+f_B*(",as.character(1+c),
            
            ")+f_C*(",as.character(1+c),
            
            ")",sep="")

fc <- paste("1+f_A*(",as.character(1+b),")+f_B+f_C",sep="")

r <- data.frame(Genotype = c("WT", "A", "B","C"),
                
                Fitness = c("1", fa, fb, fc),
                
                stringsAsFactors = FALSE)

r

afe <- allFitnessEffects(genotFitness = r,
                         
                         frequencyDependentFitness = TRUE,frequencyType ='rel')

osp <- oncoSimulPop(100,afe,
                    
                    model = "McFL",
                    
                    onlyCancer = FALSE,
                    
                    finalTime = 1000,
                    
                    verbosity = 0,
                    
                    mu = 1e-5,
                    
                    initSize = 5000,
                    
                    keepPhylog = FALSE,
                    
                    seed = NULL,
                    
                    detectionProb = NA,
                    
                    detectionSize = NA,
                    
                    errorHitMaxTries = FALSE,
                    
                    errorHitWallTime = FALSE)

# Draw a boxplot with the results of the OncoSimulPop simulation

# Returns a dataframe with the final population for each genotype

# for all simulations

popStats <- function(osp,x){
  
  
  # a function to place numbers in the same order as in the df
  
  get_right_order <- function(model,df){
    
    order_by_colname <- match(colnames(df), model$GenotypesLabels) + 1
    
    last_row <- model$pops.by.time[nrow(model$pops.by.time), ]
    
    rigth_order <- last_row[order_by_colname]
    
  }
  
  
  
  # create an empty dataframe
  
  df <- data.frame(matrix(ncol = length(x), nrow = 0))
  
  colnames(df) <- x
  
  # interate through models and add results to the df
  
  for (i in osp) {
    
    df[nrow(df) + 1, ] <- get_right_order(i,df)
    
  }
  
  return(df)
  
}


# Receives a dataframe like the one returned by function popStats:

#   Rows are the final samples from each oncoSimulIndiv

#   object inside an OncoSimulPop object

#   Columns correspond to the different genotypes

# Generates a barplot with the number of times each strategy outgrow the others

# considering also polymorphic equilibriums

getPercentages <- function (df_stats,initPopSize=5000){
  
  
  
  # remove 5% of initPopsize.
  
  # we will make the assumption that, if at the end of the 
  
  # oncoSImulIndiv simulation, population of a genotype 
  
  # is bigger that roundPop, it has achieved equilibrium
  
  roundPop <- initPopSize*5/10
  
  
  
  # remove NAs from the input data frame
  
  df_stats_cp <- df_stats[complete.cases(df_stats),] 
  
  na <- dim(df_stats)[1]-dim(df_stats_cp)[1]
  
  if ( na > 0 ){
    
    cat("Removed ",na," colums containing NA\n")
    
  }
  
  
  
  # Cosmetic change to show WT as label in the barplot 
  
  names(df_stats_cp)[1]<-paste("WT")
  
  
  
  #Set colour palette
  
  pal <- colorRampPalette(colors = c("lightblue", "blue"))(4)
  
  
  
  # Create a vector indicating the simulations
  
  # in which final population was significant for 
  
  # each genotype
  
  df_binary <-df_stats_cp > roundPop
  
  names(df_binary) <- names(df_stats_cp)
  
  
  
  winners <- vector('character')
  
  # Substitute TRUES for the name of the winner genotype 
  
  for (i in 1:dim(df_binary)[2]){
    
    df_binary[,i][df_binary[,i] == TRUE] <- names(df_binary)[i]
    
    df_binary[,i][df_binary[,i] == FALSE] <- ""
    
  }
  
  # Create a vector of winners
  
  for (i in 1:dim(df_binary)[1]){
    
    winners[i] <- paste(df_binary[i,], collapse = '')
    
  }
  
  
  
  # Plot the winning strategies
  
  barplot(table(winners), main = "Winning strategies", xlab = "Genotypes",col = pal)
  
  
  
}

x <- c("", "A", "B", "C")

pstats <- popStats(osp, x)

getPercentages(pstats)
```

There is therefore strong selection for autocrine growth factor production under this model as stated in Tomlinson and  Bodmer (1997), as long as the benefit outweighs the cost (c > 0). For example, in a situation in which the benefit of the paracrine factor is bigger than the benefit of the autocrine one, strategy b will also win since its fitness has the contribution of both of them.


When considering only strategies B and C alone, we observe that strategy B also wins but it takes more time to outgrow WT cells than when strategy A is also present. This indicates, even though strategy A has always disadvantage if a>0, its presence can lead to faster tumor growth.

Taking the data form the previous example:
  
  ```{r}
# Plot genotypes sizes along time


osi <- oncoSimulIndiv(afe,
                     
                     model = "McFL",
                     
                     onlyCancer = FALSE,
                     
                     finalTime = 1000,
                     
                     verbosity = 0,
                     
                     mu = 1e-5,
                     
                     initSize = 5000,
                     
                     keepPhylog = FALSE,
                     
                     seed = NULL,
                     
                     detectionProb = NA,
                     
                     detectionSize = NA,
                     
                     errorHitMaxTries = FALSE,
                     
                     errorHitWallTime = FALSE)

plot(osi, show = "genotypes", type = "line")

```

```{r}
c <- 2 

fb <- paste("1+f_B*(",as.character(1+c),
            
            ")+f_C*(",as.character(1+c),
            
            ")",sep="")

fc <- paste("1+f_B+f_C",sep="")

rBC <- data.frame(Genotype = c("WT", "1", "2"),
                  
                  Fitness = c("1", fb, fc),
                  
                  stringsAsFactors = FALSE)

rBC

afeBC <- allFitnessEffects(genotFitness = rBC,
                           
                           frequencyDependentFitness = TRUE,frequencyType ='rel')

osiBC <- oncoSimulnIndiv(afeBC,
                       
                       model = "McFL",
                       
                       onlyCancer = FALSE,
                       
                       finalTime = 1000,
                       
                       verbosity = 0,
                       
                       mu = 1e-5,
                       
                       initSize = 5000,
                       
                       keepPhylog = FALSE,
                       
                       seed = NULL,
                       
                       detectionProb = NA,
                       
                       detectionSize = NA,
                       
                       errorHitMaxTries = FALSE,
                       
                       errorHitWallTime = FALSE)

# Plot genotypes sizes along time

plot(osiBC, show = "genotypes", type = "line")
```

#### Angiogenesis {#Angiogenesis}

Tumors cannot grow without access to the circulatory system. Cells capable of angiogenesis produce growth factors that promote the creation of new blood vessels that can provide nutrients and oxygen to the tumor. 

In this model , taken also from Tomlinson and Bodmer (1997), there are 2 type of mutants:
  
  1. Cells capable of producing angiogenic factors

  2. Cells that cannot produce the angiogenic factors but are susceptible to them

The payoff matrix is the following:
  
  **1		2**
  
  **1**	1 - i + j 	1 + j 

  **2**	1 - i + j		1

Being:
  
  * i the cost of producing the factor.

  * j the benefit of receiving it. 

Taking into account we have wild type cells in the tissue, from which the 2 types of mutants evolve, with a neutral fitness of 1, we can describe the fitness of all players involved in the game like this:
  
FWT = 1

F1 = 1 + f_1*(1 - i + j) + f_2*(1 - i + j )

F2 = 1 + f_1*(1 + j) + f_2 

We model this game using OncoSimulR, with 2 genes and 3 possible genotypes, being just 3 of them viables (the other will have fitnes 0).

```{r}
f1 <- paste("1+f_1*(",as.character(1-i+j),")+f_2*(",as.character(1-i+j),")",sep="")

f2 <- paste("1+f_1*(",as.character(1+j),")+f_2",sep="")


r <- data.frame(Genotype = c("WT",
                             
                             "1", "2"),
                
                Fitness = c("1",
                            
                            f1,
                            
                            f2),
                
                stringsAsFactors = FALSE)

r
```

We start from a WT population of 5000 cells, and run the simulations 1000 time units, with a mutation rate of 1e-5  to see faster the dynamics of the tumor cells evolution. 

```{r}
osp <- oncoSimulPop(100,afe,
                    
                    model = "McFL",
                    
                    onlyCancer = FALSE,
                    
                    finalTime = 1000,
                    
                    verbosity = 0,
                    
                    mu = 1e-5,
                    
                    initSize = isize,
                    
                    keepPhylog = FALSE,
                    
                    seed = NULL,
                    
                    detectionProb = NA,
                    
                    detectionSize = NA,
                    
                    errorHitMaxTries = FALSE,
                    
                    errorHitWallTime = FALSE)

y <- c("", "1", "2")

pstats <- popStats(osp, y)

getPercentages(pstats)
```

Results from the simulations don’t quite match the main theoretical insight extracted from Tomlinson and Bodmer (1997). For them, as long as the benefit j of angiogenesis is greater than the cost i of producing angiogenic factors then both types of strategies will be present in a tumour in a polymorphic equilibrium. In our case we have reached such equilibrium 30% of the times, while strategy 1 wins 26%, but we have run simulations only 100 times.


Here we can see the polymorphic equilibrium:
  
  ```{r}
osi <- oncoSimulIndiv(afe,
                     
                     model = "McFL",
                     
                     onlyCancer = FALSE,
                     
                     finalTime = 1000,
                     
                     verbosity = 0,
                     
                     mu = 1e-5,
                     
                     initSize = 5000,
                     
                     keepPhylog = FALSE,
                     
                     seed = NULL,
                     
                     detectionProb = NA,
                     
                     detectionSize = NA,
                     
                     errorHitMaxTries = FALSE,
                     
                     errorHitWallTime = FALSE)

# Plot genotypes sizes along time

plot(osi, show = "genotypes", type = "line")

```

In the case in which the cost is bigger than the benefit (i.e. i = 2,  j = 1), the result is the advantage of strategy 2 as stated by Tomlinson and Bodmer (1997), although there is an important fraction of the simulations in which mutants don’t get to outgrow WT cells:
  
  This could be because mutant 2 fitness depend on mutant 1 since it is a non-producer. In cases in which this one does not reach a significant population, because the cost of producing the angiogenic factor is smaller than the benefit, mutant 2 will lost its competitive advantage against WT.

According to Tomlinson and Bodmer (1997), the outcome of this model depends a lot on the initial population of the mutants. In our case we can just specify a number of initial WT individuals with no mutations present. It will be interesting to be able to compare results starting from different distributions of population.

#### Motility {#Motility}

#### Toxicity {#Toxicity}
